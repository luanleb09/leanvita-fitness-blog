<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>B√†i vi·∫øt</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      max-width: 800px;
      margin: auto;
      background: #f9f9f9;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    img {
      max-width: 100%;
      margin: 1rem 0;
      border-radius: 6px;
    }
    p {
      line-height: 1.6;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <h1 id="post-title">ƒêang t·∫£i b√†i vi·∫øt...</h1>
  <div id="post-container"></div>

  <script>
    const SHEET_ID = '1m9Fy1dbFL2q3RimNacf8VnqA5CYFGnRv2lul60yHxbQ'
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`

    async function fetchPosts() {
      const res = await fetch(SHEET_URL)
      const text = await res.text()
      const json = JSON.parse(text.substring(47).slice(0, -2))
      const rows = json.table.rows

      return rows.map(row => ({
        title: row.c[0]?.v || '',
        slug: row.c[1]?.v || '',
        thumbnail: row.c[2]?.v || '',
        content_url: row.c[3]?.v || '',
        date: row.c[4]?.v || '',
        tags: row.c[5]?.v || '',
      }))
    }

    async function fetchGoogleDocContent(docId, apiKey) {
      const res = await fetch(`https://docs.googleapis.com/v1/documents/${docId}?key=${apiKey}`)
      return await res.json()
    }

    function renderGoogleDoc(doc) {
      const container = document.getElementById('post-container')
      const elements = doc.body.content
      container.innerHTML = ''

      elements.forEach(el => {
        if (el.paragraph) {
          const p = document.createElement('p')
          el.paragraph.elements.forEach(e => {
            const run = e.textRun
            if (run?.content?.trim()) {
              const span = document.createElement('span')
              if (run.textStyle?.bold) span.style.fontWeight = 'bold'
              if (run.textStyle?.italic) span.style.fontStyle = 'italic'
              span.textContent = run.content
              p.appendChild(span)
            }
          })
          container.appendChild(p)
        }

        if (el.inlineObjectElement) {
          const objectId = el.inlineObjectElement.inlineObjectId
          const inlineObj = doc.inlineObjects?.[objectId]
          const imgSrc = inlineObj?.inlineObjectProperties?.embeddedObject?.imageProperties?.contentUri

          if (imgSrc) {
            const img = document.createElement('img')
            img.src = imgSrc
            container.appendChild(img)
          }
        }
      })
    }

    (async () => {
      const urlParams = new URLSearchParams(window.location.search)
      const slug = urlParams.get('slug')

      const posts = await fetchPosts()
      const post = posts.find(p => p.slug === slug)

      if (!post) {
        document.getElementById('post-title').textContent = 'B√†i vi·∫øt kh√¥ng t·ªìn t·∫°i'
        return
      }

      document.getElementById('post-title').textContent = post.title

      const match = post.content_url.match(/\/document\/d\/([a-zA-Z0-9-_]+)/)
      const docId = match?.[1]

      if (!docId) {
        document.getElementById('post-container').innerHTML = '<p>Kh√¥ng t√¨m th·∫•y Google Docs h·ª£p l·ªá.</p>'
        return
      }

      const API_KEY = 'AIzaSyBn1JdbdhHuyb6vH6JugkBhKpmkbpK9tvs' // üëà Thay b·∫±ng Google API Key th·∫≠t
      const doc = await fetchGoogleDocContent(docId, API_KEY)
      renderGoogleDoc(doc)
    })()
  </script>
</body>
</html>
